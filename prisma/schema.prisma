generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id             Int            @id @default(autoincrement())
  email          String         @unique
  senha_hash     String
  created_at     DateTime       @default(now())
  contagens      Contagem[]
  produtos       Produto[]
  codigos_barras CodigoBarras[]

  @@map("usuarios")
}

model Produto {
  id             Int            @id @default(autoincrement())
  codigo_produto String
  descricao      String
  saldo_estoque  Int            @default(0)
  created_at     DateTime       @default(now())
  usuario_id     Int
  usuario        Usuario        @relation(fields: [usuario_id], references: [id])
  codigos_barras CodigoBarras[]
  itens_contados ItemContado[]

  @@unique([codigo_produto, usuario_id])
  @@map("produtos")
}

model CodigoBarras {
  codigo_de_barras String        @id
  produto_id       Int
  created_at       DateTime      @default(now())
  usuario_id       Int
  usuario          Usuario       @relation(fields: [usuario_id], references: [id])
  produto          Produto       @relation(fields: [produto_id], references: [id], onDelete: Cascade)
  itens_contados   ItemContado[]

  @@map("codigos_de_barras")
}

model Contagem {
  id             Int           @id @default(autoincrement())
  usuario_id     Int
  data_contagem  DateTime      @default(now())
  local_estoque  String        @default("loja-1")
  status         String        @default("em_andamento")
  observacoes    String?
  usuario        Usuario       @relation(fields: [usuario_id], references: [id])
  itens_contados ItemContado[]

  @@map("contagens")
}

model ItemContado {
  id                      Int      @id @default(autoincrement())
  contagem_id             Int
  produto_id              Int
  codigo_de_barras        String
  quant_loja              Int      @default(0)
  quant_estoque           Int      @default(0)
  saldo_estoque_inicial  Int
  total                   Int
  data_hora               DateTime @default(now())

  contagem      Contagem     @relation(fields: [contagem_id], references: [id], onDelete: Cascade)
  produto       Produto      @relation(fields: [produto_id], references: [id])
  // A relação com CodigoBarras é baseada em uma string, não precisa de @relation aqui
  // o que simplifica a criação de itens temporários.

  @@unique([contagem_id, produto_id])
  @@map("itens_contados")
}